<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Actualizar Contraseña - Arashi</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { background: #080c15; color: white; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; width: 100vw; overflow: hidden; }
        .card { background: rgba(30, 41, 59, 0.4); padding: 40px 25px; border-radius: 35px; border: 1px solid rgba(255,255,255,0.1); width: 85%; max-width: 340px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 16px; margin-bottom: 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); background: #0f172a; color: white; box-sizing: border-box; outline: none; font-size: 16px; text-align: center; text-transform: uppercase; }
        input::placeholder { text-transform: none; }
        button { background: #ef4444; color: white; border: none; width: 100%; padding: 18px; border-radius: 20px; font-weight: 800; cursor: pointer; text-transform: uppercase; margin-top: 10px; transition: 0.3s; }
        button:disabled { background: #334155; opacity: 0.5; cursor: not-allowed; }
        .logo { width: 90px; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(239,68,68,0.3)); }
        #msg { font-size: 13px; margin-top: 20px; font-weight: bold; line-height: 1.4; }
    </style>
</head>
<body>
    <div class="card">
        <img src="img/logo-arashi.png" class="logo">
        <h2 style="font-size: 22px; margin-bottom: 10px; font-weight: 800;">NUEVA CLAVE</h2>
        <p style="color:#94a3b8; font-size:14px; margin-bottom:25px;">Formato DNI: 12345678X</p>
        
        <input type="text" id="dni" placeholder="Tu DNI (12345678X)" maxlength="9" autocomplete="off">
        <input type="password" id="p1" placeholder="Nueva Contraseña">
        <input type="password" id="p2" placeholder="Repetir Contraseña">
        
        <button id="btn-save" onclick="ejecutarCambio()">Actualizar Contraseña</button>
        <p id="msg"></p>
    </div>

    <script>
        // Validar formato DNI en tiempo real
        const dniInput = document.getElementById('dni');
        dniInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^0-9A-Z]/g, '');
        });

        async function ejecutarCambio() {
            const dni = dniInput.value.trim();
            const p1 = document.getElementById('p1').value;
            const p2 = document.getElementById('p2').value;
            const msg = document.getElementById('msg');
            const btn = document.getElementById('btn-save');

            // --- PEGA AQUÍ TU TOKEN NUEVO (Settings > API Tokens) ---
            const MASTER_TOKEN = "8806aa4ea3553493ba4b21a98f850ad406b5d7a71286e4892f502474dca1cb611381ae42d87c221224dcfc031a9e408f3a0de37e19d8f92d9576679ac716b2d3456da0c7dac1c840c1847e56e506f26520d3a99977d92f47461b5c869ba08e0d5b3cb99f1caa04fb4c814a7623a65b63b6bed7cc246e3279ff7917610379b7f0";

            // Validar formato estricto (8 números + 1 letra)
            const dniRegex = /^[0-9]{8}[A-Z]$/;
            if (!dniRegex.test(dni)) {
                msg.innerText = "Error: El DNI debe tener 8 números y 1 letra (Ej: 12345678X).";
                msg.style.color = "#ef4444";
                return;
            }

            if (p1 !== p2 || p1.length < 6) {
                msg.innerText = "Las claves deben coincidir y tener al menos 6 caracteres.";
                msg.style.color = "#ef4444";
                return;
            }

            msg.innerText = "Verificando con el Dojo...";
            msg.style.color = "white";
            btn.disabled = true;

            try {
                // 1. Buscar usuario
                const resSearch = await fetch(`https://elegant-acoustics-3b7e60f840.strapiapp.com/api/users?filters[username][$eq]=${dni}`, {
                    headers: { 'Authorization': `Bearer ${MASTER_TOKEN}` }
                });

                if (resSearch.status === 401) {
                    throw new Error("Error de permisos (Token inválido)");
                }

                const users = await resSearch.json();

                if (!users || users.length === 0) {
                    msg.innerText = "DNI no encontrado en el sistema.";
                    msg.style.color = "#ef4444";
                    btn.disabled = false;
                    return;
                }

                const userId = users[0].id;

                // 2. Actualizar
                const resUpdate = await fetch(`https://elegant-acoustics-3b7e60f840.strapiapp.com/api/users/${userId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MASTER_TOKEN}` 
                    },
                    body: JSON.stringify({ password: p1 })
                });

                if (resUpdate.ok) {
                    msg.style.color = "#22c55e";
                    msg.innerText = "¡CONTRASENA ACTUALIZADA!\nRedirigiendo...";
                    setTimeout(() => window.location.href = "movil.html", 2500);
                } else {
                    msg.innerText = "Error al actualizar. Contacta al Sensei.";
                    msg.style.color = "#ef4444";
                    btn.disabled = false;
                }
            } catch (e) {
                msg.innerText = e.message === "Error de permisos (Token inválido)" 
                    ? "Error técnico: El Token no es correcto." 
                    : "Fallo de conexión con Strapi.";
                msg.style.color = "#ef4444";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>